<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lost Time Maintenance Input</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loginScreen">
        <img src="https://cdn-icons-png.flaticon.com/512/3344/3344378.png" alt="Engineering Icon">
        <h2>Login Maintenance</h2>
        <div class="form-group"><label>ID</label><input type="text" id="loginId"></div>
        <div class="form-group"><label>Password</label><input type="password" id="loginPass"></div>
        <button onclick="checkLogin()">Login</button>
        <p id="loginError" style="color:red; display:none;">ID atau Password salah!</p>
    </div>

    <div id="app" style="display:none; padding:20px;">
        <h2>Data Lost Time Maintenance</h2>
        <div class="form-container">
            <form id="maintenanceForm">
                <div class="form-group"><label>Date</label><input type="date" id="date" required></div>
                <div class="form-group"><label>Machine</label>
                    <select id="machine" required>
                        <option>Conveyor</option><option>Pretreatment</option><option>Oven</option>
                        <option>Primer</option><option>Base Coat</option><option>PPH 308</option>
                        <option>Clear Coat</option><option>Sludge Removal</option>
                        <option>Air Supply Unit</option><option>COMM</option><option>Boiler</option>
                    </select></div>
                <div class="form-group"><label>Category</label>
                    <select id="category" required>
                        <option>Mechanic</option><option>Electrical</option><option>System / Program</option>
                        <option>Pneumatic</option><option>Fabrication</option>
                        <option>Spray Equipment</option><option>Heating Process</option>
                    </select></div>
                <div class="form-group"><label>Trouble Detail</label><textarea id="trouble" rows="2" required></textarea></div>
                <div class="form-group"><label>Analysis</label><textarea id="analysis" rows="2" required></textarea></div>
                <div class="form-group"><label>Repair Improvement</label><textarea id="repair" rows="2" required></textarea></div>
                <div class="form-group"><label>Lost Time (Minute)</label><input type="number" id="lostTime" min="0" required></div>
                <div class="form-group"><label>PIC</label>
                    <select id="pic" required>
                        <option>Dandik</option><option>Davit</option><option>Triyono</option>
                        <option>Muchrobin</option><option>Ali</option><option>Slamet</option>
                        <option>Joni</option><option>Dede</option><option>A Apandi</option>
                    </select></div>
                <button type="submit">Tambah Data</button>
            </form>
        </div>

        <div style="text-align:center; margin-top:20px;">
            <button onclick="downloadExcel()">Download Excel</button>
            <label style="color:#fff;">Print Berdasarkan:</label>
            <select id="printFilter" class="filter">
                <option value="all">Semua Data</option>
                <option value="month">Bulan</option>
                <option value="week">Minggu</option>
            </select>
            <button onclick="printData()">Print</button>
        </div>
        
        <div style="text-align:center; margin-top:20px;">
            <a href="dashboard.html" style="background: #00c3ff; color: #fff; padding: 10px 20px; text-decoration: none; border-radius: 6px;">Lihat Dashboard</a>
        </div>

        <table id="dataTable">
            <thead>
                <tr><th>Date</th><th>Machine</th><th>Category</th><th>Trouble</th><th>Analysis</th><th>Repair</th><th>Lost Time</th><th>PIC</th><th>Aksi</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const SUPABASE_URL = "https://skjtzbldpvmacmotdomr.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNranR6YmxkcHZtYWNtb3Rkb21yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Nzk4ODYsImV4cCI6MjA3MzA1NTg4Nn0.u8Zg2k7us_wHnamqplRYZ7rI6ls68zRZ6iLgfitTviM";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const form = document.getElementById("maintenanceForm");
        const tableBody = document.querySelector("#dataTable tbody");
        let dataRecords = [];

        function checkLogin() {
            const id = document.getElementById("loginId").value;
            const pass = document.getElementById("loginPass").value;
            if (id === "Painting" && pass === "123456") {
                document.getElementById("loginScreen").style.display = "none";
                document.getElementById("app").style.display = "block";
                loadRecords();
            } else {
                document.getElementById("loginError").style.display = "block";
            }
        }

        form.addEventListener("submit", async function(event) {
            event.preventDefault();
            const record = {
                date: document.getElementById("date").value,
                machine: document.getElementById("machine").value,
                category: document.getElementById("category").value,
                trouble: document.getElementById("trouble").value,
                analysis: document.getElementById("analysis").value,
                repair: document.getElementById("repair").value,
                lost_time: parseInt(document.getElementById("lostTime").value),
                pic: document.getElementById("pic").value
            };
            const { data, error } = await supabaseClient.from("lost_time_maintenance").insert([record]);
            if (error) { alert("Error simpan data: " + error.message); return; }
            loadRecords();
            form.reset();
        });

        async function loadRecords() {
            const { data, error } = await supabaseClient.from("lost_time_maintenance").select("*").order("date", { ascending: false });
            if (error) { console.error(error); return; }
            dataRecords = data;
            updateTable();
        }

        function updateTable() {
            tableBody.innerHTML = "";
            dataRecords.forEach(r => {
                const row = document.createElement("tr");
                row.innerHTML = `<td>${r.date}</td><td>${r.machine}</td><td>${r.category}</td>
                                 <td>${r.trouble}</td><td>${r.analysis}</td><td>${r.repair}</td>
                                 <td>${r.lost_time}</td><td>${r.pic}</td>
                                 <td><button onclick="deleteRecord('${r.id}')" style="background-color: #ff4d4d;">Hapus</button></td>`;
                tableBody.appendChild(row);
            });
        }
    
        async function deleteRecord(recordId) {
            if (confirm("Apakah Anda yakin ingin menghapus data ini?")) {
                const { error } = await supabaseClient.from("lost_time_maintenance").delete().eq("id", recordId);
                if (error) {
                    alert("Error saat menghapus data: " + error.message);
                } else {
                    loadRecords();
                }
            }
        }

        function getWeekNumber(dateStr) {
            const d = new Date(dateStr);
            const oneJan = new Date(d.getFullYear(),0,1);
            const numberOfDays = Math.floor((d - oneJan) / (24 * 60 * 60 * 1000));
            return Math.ceil((d.getDay() + 1 + numberOfDays) / 7);
        }

        function downloadExcel() {
            const ws = XLSX.utils.json_to_sheet(dataRecords);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "LostTimeData");
            XLSX.writeFile(wb, "LostTimeMaintenance.xlsx");
        }

        function printData() {
            const filter = document.getElementById("printFilter").value;
            let filtered = dataRecords;
            if (filter === "month") {
                const month = prompt("Masukkan bulan (YYYY-MM):"); 
                if (!month) return;
                filtered = dataRecords.filter(r => r.date.startsWith(month));
            } else if (filter === "week") {
                const week = prompt("Masukkan minggu (YYYY-Wxx):"); 
                if (!week) return;
                filtered = dataRecords.filter(r => r.date.slice(0,4) + "-W" + getWeekNumber(r.date) === week);
            }
            let html = "<h2>Data Lost Time Maintenance</h2><table border='1'><tr><th>Date</th><th>Machine</th><th>Category</th><th>Trouble</th><th>Analysis</th><th>Repair</th><th>Lost Time</th><th>PIC</th></tr>";
            filtered.forEach(r => { html += `<tr><td>${r.date}</td><td>${r.machine}</td><td>${r.category}</td><td>${r.trouble}</td><td>${r.analysis}</td><td>${r.repair}</td><td>${r.lost_time}</td><td>${r.pic}</td></tr>`; });
            const w = window.open("", "_blank"); w.document.write(html); w.print();
        }
    </script>
</body>
</html>